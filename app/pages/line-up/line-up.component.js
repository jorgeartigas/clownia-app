"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var user_service_1 = require("./../../shared/user/user.service");
var core_1 = require("@angular/core");
var drawer_page_1 = require("../../shared/drawer/drawer.page");
var firebase = require("nativescript-plugin-firebase");
var LocalNotifications = require("nativescript-local-notifications");
var nativescript_feedback_1 = require("nativescript-feedback");
var color_1 = require("tns-core-modules/color/color");
var LineUpComponent = /** @class */ (function (_super) {
    __extends(LineUpComponent, _super);
    function LineUpComponent(changeDetectorRef, userService) {
        var _this = _super.call(this, changeDetectorRef) || this;
        _this.changeDetectorRef = changeDetectorRef;
        _this.userService = userService;
        _this.artists = [];
        _this.myShedule = false;
        _this.artistsRef = firebase.firestore.collection("artists_preview").orderBy("name", "asc");
        _this.artistsBySetTime = firebase.firestore.collection("artists_preview").orderBy("set", "asc");
        // Own Schedule
        _this.localSchedule = [];
        _this.myScheduleArtists = [];
        // Artist by time
        _this.firstDay = [];
        _this.secondDay = [];
        _this.thirdDay = [];
        _this.fourthDay = [];
        // Artist by stages and times
        _this.mainStageSchedule = [];
        _this.plazaSchedule = [];
        _this.esplanadaSchedule = [];
        _this.carpaSchedule = [];
        // Stage toggles
        _this.mainStageToggle = false;
        _this.plazaToggle = false;
        _this.esplanadaToggle = false;
        _this.carpaToggle = false;
        _this.feedback = new nativescript_feedback_1.Feedback();
        return _this;
    }
    LineUpComponent.prototype.ngOnInit = function () {
        var _this = this;
        LocalNotifications.hasPermission();
        this.artistsRef.get().then(function (snap) {
            snap.forEach(function (artist) {
                _this.artists.push(artist.data());
            });
        });
        this.fillSchedule();
        firebase.firestore.collection("user_schedules").doc(this.userService.userId).collection('artists').get().then(function (data) {
            data.forEach(function (element) {
                var date = new Date(element.data().set);
                element.data().set = date;
                _this.localSchedule.push(element.data());
            });
        }).then(function () {
            _this.localSchedule = _this.localSchedule.sort(function (a, b) { return new Date(a.set).getTime() - new Date(b.set).getTime(); });
        });
    };
    LineUpComponent.prototype.addToSchedule = function (artist) {
        var _this = this;
        var found = false;
        if (this.localSchedule.length > 0) {
            this.localSchedule.forEach(function (myArtist) {
                if (myArtist.id === artist.id) {
                    found = true;
                }
            });
        }
        if (!found) {
            this.feedback.success({
                title: "Thumbs up!",
                titleColor: new color_1.Color("#222222"),
                position: nativescript_feedback_1.FeedbackPosition.Bottom,
                type: nativescript_feedback_1.FeedbackType.Custom,
                message: "Custom colors and icon. Loaded from the App_Resources folder.",
                messageColor: new color_1.Color("#333333"),
                duration: 3000,
                backgroundColor: new color_1.Color("yellowgreen"),
                icon: "customicon",
                android: {
                    iconColor: new color_1.Color("#222222") // optional, leave out if you don't need it
                },
                onTap: function () { _this.feedback.hide(); }
            });
            this.setNotification(artist);
            this.localSchedule.push(artist);
            firebase.firestore.collection('user_schedules').doc(this.userService.userId).collection('artists').doc(artist.id).set(artist);
        }
    };
    LineUpComponent.prototype.removeFromSchedule = function (artist) {
        var _this = this;
        this.localSchedule.forEach(function (myArtist, index) {
            if (myArtist.id === artist.id) {
                _this.localSchedule.splice(index, 1);
                firebase.firestore.collection('user_schedules').doc(_this.userService.userId).collection('artists').doc(artist.id).delete();
            }
        });
    };
    LineUpComponent.prototype.fillSchedule = function () {
        var _this = this;
        this.artistsBySetTime
            .get()
            .then(function (snap) {
            snap.forEach(function (doc) {
                if (doc.data().day == 'Dijous 28') {
                    _this.firstDay.push(doc.data());
                }
                else if (doc.data().day == 'Divendres 29') {
                    _this.secondDay.push(doc.data());
                }
                else if (doc.data().day == 'Dissabte 30') {
                    _this.thirdDay.push(doc.data());
                }
                else if (doc.data().day == 'Diumenge 1') {
                    _this.fourthDay.push(doc.data());
                }
                if (doc.data().stage === 'MAIN STAGE') {
                    _this.mainStageSchedule.push(doc.data());
                }
                else if (doc.data().stage === 'CARPA') {
                    _this.carpaSchedule.push(doc.data());
                }
                else if (doc.data().stage === 'PLAÃ‡A') {
                    _this.plazaSchedule.push(doc.data());
                }
                else {
                    _this.esplanadaSchedule.push(doc.data());
                }
            });
        }).then(function () {
            var oldDay = "";
            _this.mainStageSchedule.forEach(function (artist, index) {
                if (oldDay !== artist.day) {
                    _this.mainStageSchedule[index].firstDay = true;
                }
                else {
                    _this.mainStageSchedule[index].firstDay = false;
                }
                oldDay = artist.day;
            });
            var oldDay2 = "";
            _this.carpaSchedule.forEach(function (artist, index) {
                if (oldDay2 !== artist.day) {
                    _this.carpaSchedule[index].firstDay = true;
                }
                else {
                    _this.carpaSchedule[index].firstDay = false;
                }
                oldDay2 = artist.day;
            });
            var oldDay3 = "";
            _this.plazaSchedule.forEach(function (artist, index) {
                if (oldDay3 !== artist.day) {
                    _this.plazaSchedule[index].firstDay = true;
                }
                else {
                    _this.plazaSchedule[index].firstDay = false;
                }
                oldDay3 = artist.day;
            });
            var oldDay4 = "";
            _this.esplanadaSchedule.forEach(function (artist, index) {
                if (oldDay4 !== artist.day) {
                    _this.esplanadaSchedule[index].firstDay = true;
                }
                else {
                    _this.esplanadaSchedule[index].firstDay = false;
                }
                oldDay4 = artist.day;
            });
            var oldDay5 = "";
            _this.firstDay.forEach(function (artist, index) {
                if (oldDay5 !== artist.day) {
                    _this.firstDay[index].firstDay = true;
                }
                else {
                    _this.firstDay[index].firstDay = false;
                }
                oldDay5 = artist.day;
            });
            var oldDay6 = "";
            _this.secondDay.forEach(function (artist, index) {
                if (oldDay6 !== artist.day) {
                    _this.secondDay[index].firstDay = true;
                }
                else {
                    _this.secondDay[index].firstDay = false;
                }
                oldDay6 = artist.day;
            });
            var oldDay7 = "";
            _this.thirdDay.forEach(function (artist, index) {
                if (oldDay7 !== artist.day) {
                    _this.thirdDay[index].firstDay = true;
                }
                else {
                    _this.thirdDay[index].firstDay = false;
                }
                oldDay7 = artist.day;
            });
            var oldDay8 = "";
            _this.fourthDay.forEach(function (artist, index) {
                if (oldDay8 !== artist.day) {
                    _this.fourthDay[index].firstDay = true;
                }
                else {
                    _this.fourthDay[index].firstDay = false;
                }
                oldDay8 = artist.day;
            });
            _this.bySetTime = [].concat(_this.firstDay, _this.secondDay, _this.thirdDay, _this.fourthDay);
        });
    };
    LineUpComponent.prototype.setNotification = function (artist) {
        // Set new notification 15mins before set Time
        var d = new Date(artist.set);
        d.setTime(d.getTime() - (900000));
        LocalNotifications.schedule([{
                id: 1,
                title: artist.name + " comen\u00E7ara a les " + artist.startTime + " al " + artist.stage,
                body: "",
                badge: 1,
                groupSummary: artist.name + " is going live in 15 minutes",
                ongoing: false,
                smallIcon: 'res://tent',
                interval: 'minute',
                sound: "customsound-ios.wav",
                at: new Date(new Date().getTime() + (10 * 1000))
            }]).then(function () {
            console.log("Notification scheduled");
        }, function (error) {
            console.log("scheduling error: " + error);
        });
    };
    LineUpComponent = __decorate([
        core_1.Component({
            selector: "line-up",
            moduleId: module.id,
            providers: [],
            templateUrl: "./line-up.component.html",
            styleUrls: ["./line-up-common.css"]
        }),
        __metadata("design:paramtypes", [core_1.ChangeDetectorRef,
            user_service_1.UserService])
    ], LineUpComponent);
    return LineUpComponent;
}(drawer_page_1.DrawerPage));
exports.LineUpComponent = LineUpComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluZS11cC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsaW5lLXVwLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlFQUErRDtBQUMvRCxzQ0FBb0U7QUFDcEUsK0RBQTZEO0FBQzdELHVEQUF5RDtBQUV6RCxxRUFBdUU7QUFDdkUsK0RBQWlGO0FBQ2pGLHNEQUFxRDtBQVVyRDtJQUFxQyxtQ0FBVTtJQTJCN0MseUJBQ1UsaUJBQW9DLEVBQ3BDLFdBQXdCO1FBRmxDLFlBSUUsa0JBQU0saUJBQWlCLENBQUMsU0FFekI7UUFMUyx1QkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGlCQUFXLEdBQVgsV0FBVyxDQUFhO1FBM0JsQyxhQUFPLEdBQVUsRUFBRSxDQUFDO1FBQ3BCLGVBQVMsR0FBWSxLQUFLLENBQUM7UUFDM0IsZ0JBQVUsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEYsc0JBQWdCLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRTFGLGVBQWU7UUFDZixtQkFBYSxHQUFVLEVBQUUsQ0FBQztRQUUxQix1QkFBaUIsR0FBVSxFQUFFLENBQUM7UUFDOUIsaUJBQWlCO1FBQ2pCLGNBQVEsR0FBUSxFQUFFLENBQUM7UUFDbkIsZUFBUyxHQUFRLEVBQUUsQ0FBQztRQUNwQixjQUFRLEdBQVEsRUFBRSxDQUFDO1FBQ25CLGVBQVMsR0FBUSxFQUFFLENBQUM7UUFDcEIsNkJBQTZCO1FBQzdCLHVCQUFpQixHQUFRLEVBQUUsQ0FBQztRQUM1QixtQkFBYSxHQUFRLEVBQUUsQ0FBQztRQUN4Qix1QkFBaUIsR0FBUSxFQUFFLENBQUM7UUFDNUIsbUJBQWEsR0FBUSxF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M0IsZ0JBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxTQUFTO1lBQ25CLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNuQixTQUFTLEVBQUUsRUFBRTtZQUNiLFdBQVcsRUFBRSwwQkFBMEI7WUFDdkMsU0FBUyxFQUFFLENBQUMsc0JBQXNCLENBQUM7U0FDcEMsQ0FBQzt5Q0E4QjZCLHdCQUFpQjtZQUN2QiwwQkFBVztPQTdCdkIsZUFBZSxDQTROM0I7SUFBRCxzQkFBQztDQUFBLEFBNU5ELENBQXFDLHdCQUFVLEdBNE45QztBQTVOWSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzZXJTZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi9zaGFyZWQvdXNlci91c2VyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDb21wb25lbnQsIENoYW5nZURldGVjdG9yUmVmLCBPbkluaXR9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IERyYXdlclBhZ2UgfSBmcm9tIFwiLi4vLi4vc2hhcmVkL2RyYXdlci9kcmF3ZXIucGFnZVwiO1xyXG5pbXBvcnQgZmlyZWJhc2UgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXBsdWdpbi1maXJlYmFzZVwiKVxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcclxuaW1wb3J0ICogYXMgTG9jYWxOb3RpZmljYXRpb25zIGZyb20gXCJuYXRpdmVzY3JpcHQtbG9jYWwtbm90aWZpY2F0aW9uc1wiO1xyXG5pbXBvcnQgeyBGZWVkYmFjaywgRmVlZGJhY2tUeXBlLCBGZWVkYmFja1Bvc2l0aW9uIH0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1mZWVkYmFja1wiO1xyXG5pbXBvcnQgeyBDb2xvciB9IGZyb20gJ3Rucy1jb3JlLW1vZHVsZXMvY29sb3IvY29sb3InO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6IFwibGluZS11cFwiLFxyXG4gIG1vZHVsZUlkOiBtb2R1bGUuaWQsXHJcbiAgcHJvdmlkZXJzOiBbXSxcclxuICB0ZW1wbGF0ZVVybDogXCIuL2xpbmUtdXAuY29tcG9uZW50Lmh0bWxcIixcclxuICBzdHlsZVVybHM6IFtcIi4vbGluZS11cC1jb21tb24uY3NzXCJdXHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgTGluZVVwQ29tcG9uZW50IGV4dGVuZHMgRHJhd2VyUGFnZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgcHJpdmF0ZSBmZWVkYmFjazogRmVlZGJhY2s7XHJcbiAgYXJ0aXN0czogYW55W10gPSBbXTtcclxuICBteVNoZWR1bGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBhcnRpc3RzUmVmID0gZmlyZWJhc2UuZmlyZXN0b3JlLmNvbGxlY3Rpb24oXCJhcnRpc3RzX3ByZXZpZXdcIikub3JkZXJCeShcIm5hbWVcIixcImFzY1wiKTtcclxuICBhcnRpc3RzQnlTZXRUaW1lID0gZmlyZWJhc2UuZmlyZXN0b3JlLmNvbGxlY3Rpb24oXCJhcnRpc3RzX3ByZXZpZXdcIikub3JkZXJCeShcInNldFwiLCBcImFzY1wiKTtcclxuICBieVNldFRpbWU6IGFueTtcclxuICAvLyBPd24gU2NoZWR1bGVcclxuICBsb2NhbFNjaGVkdWxlOiBhbnlbXSA9IFtdO1xyXG4gIG15U2NoZWR1bGVBcnRpc3RzJDogT2JzZXJ2YWJsZTxhbnk+O1xyXG4gIG15U2NoZWR1bGVBcnRpc3RzOiBhbnlbXSA9IFtdO1xyXG4gIC8vIEFydGlzdCBieSB0aW1lXHJcbiAgZmlyc3REYXk6IGFueSA9IFtdO1xyXG4gIHNlY29uZERheTogYW55ID0gW107XHJcbiAgdGhpcmREYXk6IGFueSA9IFtdO1xyXG4gIGZvdXJ0aERheTogYW55ID0gW107XHJcbiAgLy8gQXJ0aXN0IGJ5IHN0YWdlcyBhbmQgdGltZXNcclxuICBtYWluU3RhZ2VTY2hlZHVsZTogYW55ID0gW107XHJcbiAgcGxhemFTY2hlZHVsZTogYW55ID0gW107XHJcbiAgZXNwbGFuYWRhU2NoZWR1bGU6IGFueSA9IFtdO1xyXG4gIGNhcnBhU2NoZWR1bGU6IGFueSA9IFtdO1xyXG4gIC8vIFN0YWdlIHRvZ2dsZXNcclxuICBtYWluU3RhZ2VUb2dnbGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBwbGF6YVRvZ2dsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIGVzcGxhbmFkYVRvZ2dsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIGNhcnBhVG9nZ2xlOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvclJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBwcml2YXRlIHVzZXJTZXJ2aWNlOiBVc2VyU2VydmljZVxyXG4gICl7XHJcbiAgICBzdXBlcihjaGFuZ2VEZXRlY3RvclJlZik7XHJcbiAgICB0aGlzLmZlZWRiYWNrID0gbmV3IEZlZWRiYWNrKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIExvY2FsTm90aWZpY2F0aW9ucy5oYXNQZXJtaXNzaW9uKCk7XHJcbiAgICB0aGlzLmFydGlzdHNSZWYuZ2V0KCkudGhlbihzbmFwID0+IHtcclxuICAgICAgc25hcC5mb3JFYWNoKGFydGlzdCA9PiB7XHJcbiAgICAgICAgdGhpcy5hcnRpc3RzLnB1c2goYXJ0aXN0LmRhdGEoKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLmZpbGxTY2hlZHVsZSgpO1xyXG4gICAgZmlyZWJhc2UuZmlyZXN0b3JlLmNvbGxlY3Rpb24oXCJ1c2VyX3NjaGVkdWxlc1wiKS5kb2ModGhpcy51c2VyU2VydmljZS51c2VySWQpLmNvbGxlY3Rpb24oJ2FydGlzdHMnKS5nZXQoKS50aGVuKGRhdGEgPT4ge1xyXG4gICAgICBkYXRhLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKGVsZW1lbnQuZGF0YSgpLnNldCk7XHJcbiAgICAgICAgZWxlbWVudC5kYXRhKCkuc2V0ID0gZGF0ZTsgXHJcbiAgICAgICAgdGhpcy5sb2NhbFNjaGVkdWxlLnB1c2goZWxlbWVudC5kYXRhKCkpO1xyXG4gICAgICB9KTsgIFxyXG4gICAgfSkudGhlbigoKT0+e1xyXG4gICAgICB0aGlzLmxvY2FsU2NoZWR1bGUgPSB0aGlzLmxvY2FsU2NoZWR1bGUuc29ydCgoYTogYW55LCBiOiBhbnkpID0+IG5ldyBEYXRlKGEuc2V0KS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShiLnNldCkuZ2V0VGltZSgpKTtcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYWRkVG9TY2hlZHVsZShhcnRpc3Q6IGFueSk6IHZvaWQge1xyXG4gICAgbGV0IGZvdW5kID0gZmFsc2U7XHJcbiAgICBpZiAodGhpcy5sb2NhbFNjaGVkdWxlLmxlbmd0aD4wKSB7XHJcbiAgICAgIHRoaXMubG9jYWxTY2hlZHVsZS5mb3JFYWNoKG15QXJ0aXN0ID0+IHtcclxuICAgICAgICBpZiAobXlBcnRpc3QuaWQgPT09IGFydGlzdC5pZCkge1xyXG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIH1cclxuICAgIGlmICghZm91bmQpIHtcclxuICAgICAgdGhpcy5mZWVkYmFjay5zdWNjZXNzKHtcclxuICAgICAgICB0aXRsZTogXCJUaHVtYnMgdXAhXCIsXHJcbiAgICAgICAgdGl0bGVDb2xvcjogbmV3IENvbG9yKFwiIzIyMjIyMlwiKSxcclxuICAgICAgICBwb3NpdGlvbjogRmVlZGJhY2tQb3NpdGlvbi5Cb3R0b20sIC8vIGlPUyBvbmx5XHJcbiAgICAgICAgdHlwZTogRmVlZGJhY2tUeXBlLkN1c3RvbSwgLy8gdGhpcyBpcyB0aGUgZGVmYXVsdCB0eXBlLCBieSB0aGUgd2F5XHJcbiAgICAgICAgbWVzc2FnZTogXCJDdXN0b20gY29sb3JzIGFuZCBpY29uLiBMb2FkZWQgZnJvbSB0aGUgQXBwX1Jlc291cmNlcyBmb2xkZXIuXCIsXHJcbiAgICAgICAgbWVzc2FnZUNvbG9yOiBuZXcgQ29sb3IoXCIjMzMzMzMzXCIpLFxyXG4gICAgICAgIGR1cmF0aW9uOiAzMDAwLFxyXG4gICAgICAgIGJhY2tncm91bmRDb2xvcjogbmV3IENvbG9yKFwieWVsbG93Z3JlZW5cIiksXHJcbiAgICAgICAgaWNvbjogXCJjdXN0b21pY29uXCIsIC8vIGluIEFwcF9SZXNvdXJjZXMvcGxhdGZvcm0gZm9sZGVyc1xyXG4gICAgICAgIGFuZHJvaWQ6IHtcclxuICAgICAgICAgIGljb25Db2xvcjogbmV3IENvbG9yKFwiIzIyMjIyMlwiKSAvLyBvcHRpb25hbCwgbGVhdmUgb3V0IGlmIHlvdSBkb24ndCBuZWVkIGl0XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvblRhcDogKCkgPT4geyB0aGlzLmZlZWRiYWNrLmhpZGUoKSB9XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLnNldE5vdGlmaWNhdGlvbihhcnRpc3QpO1xyXG4gICAgICB0aGlzLmxvY2FsU2NoZWR1bGUucHVzaChhcnRpc3QpO1xyXG4gICAgICBmaXJlYmFzZS5maXJlc3RvcmUuY29sbGVjdGlvbigndXNlcl9zY2hlZHVsZXMnKS5kb2ModGhpcy51c2VyU2VydmljZS51c2VySWQpLmNvbGxlY3Rpb24oJ2FydGlzdHMnKS5kb2MoYXJ0aXN0LmlkKS5zZXQoYXJ0aXN0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyByZW1vdmVGcm9tU2NoZWR1bGUoYXJ0aXN0OiBhbnkpOiB2b2lkIHtcclxuICAgIHRoaXMubG9jYWxTY2hlZHVsZS5mb3JFYWNoKChteUFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICBpZiAobXlBcnRpc3QuaWQgPT09IGFydGlzdC5pZCkge1xyXG4gICAgICAgIHRoaXMubG9jYWxTY2hlZHVsZS5zcGxpY2UoaW5kZXgsMSk7XHJcbiAgICAgICAgZmlyZWJhc2UuZmlyZXN0b3JlLmNvbGxlY3Rpb24oJ3VzZXJfc2NoZWR1bGVzJykuZG9jKHRoaXMudXNlclNlcnZpY2UudXNlcklkKS5jb2xsZWN0aW9uKCdhcnRpc3RzJykuZG9jKGFydGlzdC5pZCkuZGVsZXRlKCk7XHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZpbGxTY2hlZHVsZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuYXJ0aXN0c0J5U2V0VGltZVxyXG4gICAgLmdldCgpXHJcbiAgICAudGhlbihzbmFwID0+IHtcclxuICAgICAgc25hcC5mb3JFYWNoKGRvYyA9PiB7XHJcbiAgICAgICAgaWYoZG9jLmRhdGEoKS5kYXkgPT0gJ0Rpam91cyAyOCcpIHtcclxuICAgICAgICAgIHRoaXMuZmlyc3REYXkucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGRvYy5kYXRhKCkuZGF5ID09ICdEaXZlbmRyZXMgMjknKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2Vjb25kRGF5LnB1c2goZG9jLmRhdGEoKSk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGRvYy5kYXRhKCkuZGF5ID09ICdEaXNzYWJ0ZSAzMCcpIHtcclxuICAgICAgICAgICAgICB0aGlzLnRoaXJkRGF5LnB1c2goZG9jLmRhdGEoKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jLmRhdGEoKS5kYXkgPT0gJ0RpdW1lbmdlIDEnKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuZm91cnRoRGF5LnB1c2goZG9jLmRhdGEoKSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgIGlmKGRvYy5kYXRhKCkuc3RhZ2UgPT09ICdNQUlOIFNUQUdFJykge1xyXG4gICAgICAgICAgdGhpcy5tYWluU3RhZ2VTY2hlZHVsZS5wdXNoKGRvYy5kYXRhKCkpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZG9jLmRhdGEoKS5zdGFnZSA9PT0gJ0NBUlBBJykge1xyXG4gICAgICAgICAgICB0aGlzLmNhcnBhU2NoZWR1bGUucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoZG9jLmRhdGEoKS5zdGFnZSA9PT0gJ1BMQcOHQScpIHtcclxuICAgICAgICAgICAgICB0aGlzLnBsYXphU2NoZWR1bGUucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXNwbGFuYWRhU2NoZWR1bGUucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pLnRoZW4oKCk9PntcclxuICAgICAgbGV0IG9sZERheSA9IFwiXCI7XHJcbiAgICAgIHRoaXMubWFpblN0YWdlU2NoZWR1bGUuZm9yRWFjaCgoYXJ0aXN0LGluZGV4KSA9PiB7XHJcbiAgICAgICAgaWYob2xkRGF5ICE9PSBhcnRpc3QuZGF5KXtcclxuICAgICAgICAgIHRoaXMubWFpblN0YWdlU2NoZWR1bGVbaW5kZXhdLmZpcnN0RGF5ID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5tYWluU3RhZ2VTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5ID0gYXJ0aXN0LmRheTtcclxuICAgICAgfSk7XHJcbiAgICAgIGxldCBvbGREYXkyID0gXCJcIjtcclxuICAgICAgdGhpcy5jYXJwYVNjaGVkdWxlLmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTIgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy5jYXJwYVNjaGVkdWxlW2luZGV4XS5maXJzdERheSA9IHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuY2FycGFTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5MiA9IGFydGlzdC5kYXk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBsZXQgb2xkRGF5MyA9IFwiXCI7XHJcbiAgICAgIHRoaXMucGxhemFTY2hlZHVsZS5mb3JFYWNoKChhcnRpc3QsaW5kZXgpID0+IHtcclxuICAgICAgICBpZihvbGREYXkzICE9PSBhcnRpc3QuZGF5KXtcclxuICAgICAgICAgIHRoaXMucGxhemFTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLnBsYXphU2NoZWR1bGVbaW5kZXhdLmZpcnN0RGF5ID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9sZERheTMgPSBhcnRpc3QuZGF5O1xyXG4gICAgICB9KTtcclxuICAgICAgbGV0IG9sZERheTQgPSBcIlwiO1xyXG4gICAgICB0aGlzLmVzcGxhbmFkYVNjaGVkdWxlLmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTQgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy5lc3BsYW5hZGFTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmVzcGxhbmFkYVNjaGVkdWxlW2luZGV4XS5maXJzdERheSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvbGREYXk0ID0gYXJ0aXN0LmRheTtcclxuICAgICAgfSk7XHJcbiAgICAgIGxldCBvbGREYXk1ID0gXCJcIjtcclxuICAgICAgdGhpcy5maXJzdERheS5mb3JFYWNoKChhcnRpc3QsaW5kZXgpID0+IHtcclxuICAgICAgICBpZihvbGREYXk1ICE9PSBhcnRpc3QuZGF5KXtcclxuICAgICAgICAgIHRoaXMuZmlyc3REYXlbaW5kZXhdLmZpcnN0RGF5ID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5maXJzdERheVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5NSA9IGFydGlzdC5kYXk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBsZXQgb2xkRGF5NiA9IFwiXCI7XHJcbiAgICAgIHRoaXMuc2Vjb25kRGF5LmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTYgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy5zZWNvbmREYXlbaW5kZXhdLmZpcnN0RGF5ID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5zZWNvbmREYXlbaW5kZXhdLmZpcnN0RGF5ID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9sZERheTYgPSBhcnRpc3QuZGF5O1xyXG4gICAgICB9KTtcclxuICAgICAgbGV0IG9sZERheTcgPSBcIlwiO1xyXG4gICAgICB0aGlzLnRoaXJkRGF5LmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTcgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy50aGlyZERheVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLnRoaXJkRGF5W2luZGV4XS5maXJzdERheSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvbGREYXk3ID0gYXJ0aXN0LmRheTtcclxuICAgICAgfSk7XHJcbiAgICAgIGxldCBvbGREYXk4ID0gXCJcIjtcclxuICAgICAgdGhpcy5mb3VydGhEYXkuZm9yRWFjaCgoYXJ0aXN0LGluZGV4KSA9PiB7XHJcbiAgICAgICAgaWYob2xkRGF5OCAhPT0gYXJ0aXN0LmRheSl7XHJcbiAgICAgICAgICB0aGlzLmZvdXJ0aERheVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmZvdXJ0aERheVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5OCA9IGFydGlzdC5kYXk7XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLmJ5U2V0VGltZSA9IFtdLmNvbmNhdCh0aGlzLmZpcnN0RGF5LHRoaXMuc2Vjb25kRGF5LHRoaXMudGhpcmREYXksdGhpcy5mb3VydGhEYXkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0Tm90aWZpY2F0aW9uKGFydGlzdDogYW55KTogdm9pZCB7XHJcbiAgICAvLyBTZXQgbmV3IG5vdGlmaWNhdGlvbiAxNW1pbnMgYmVmb3JlIHNldCBUaW1lXHJcbiAgICBjb25zdCBkID0gbmV3IERhdGUoYXJ0aXN0LnNldCk7XHJcbiAgICBkLnNldFRpbWUoZC5nZXRUaW1lKCktKDkwMDAwMCkpO1xyXG5cclxuICAgIExvY2FsTm90aWZpY2F0aW9ucy5zY2hlZHVsZShbe1xyXG4gICAgICBpZDogMSxcclxuICAgICAgdGl0bGU6IGAke2FydGlzdC5uYW1lfSBjb21lbsOnYXJhIGEgbGVzICR7YXJ0aXN0LnN0YXJ0VGltZX0gYWwgJHthcnRpc3Quc3RhZ2V9YCxcclxuICAgICAgYm9keTogXCJcIixcclxuICAgICAgYmFkZ2U6IDEsXHJcbiAgICAgIGdyb3VwU3VtbWFyeTogYCR7YXJ0aXN0Lm5hbWV9IGlzIGdvaW5nIGxpdmUgaW4gMTUgbWludXRlc2AsIC8vYW5kcm9pZCBvbmx5XHJcbiAgICAgIG9uZ29pbmc6IGZhbHNlLCAvLyBtYWtlcyB0aGUgbm90aWZpY2F0aW9uIG9uZ29pbmcgKEFuZHJvaWQgb25seSlcclxuICAgICAgc21hbGxJY29uOiAncmVzOi8vdGVudCcsXHJcbiAgICAgIGludGVydmFsOiAnbWludXRlJyxcclxuICAgICAgc291bmQ6IFwiY3VzdG9tc291bmQtaW9zLndhdlwiLCAvLyBmYWxscyBiYWNrIHRvIHRoZSBkZWZhdWx0IHNvdW5kIG9uIEFuZHJvaWRcclxuICAgICAgYXQ6IG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpKygxMCoxMDAwKSlcclxuICAgIH1dKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJOb3RpZmljYXRpb24gc2NoZWR1bGVkXCIpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKFwic2NoZWR1bGluZyBlcnJvcjogXCIgKyBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgKVxyXG4gIH1cclxufSJdfQ==