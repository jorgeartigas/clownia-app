"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var user_service_1 = require("./../../shared/user/user.service");
var core_1 = require("@angular/core");
var drawer_page_1 = require("../../shared/drawer/drawer.page");
var firebase = require("nativescript-plugin-firebase");
var LocalNotifications = require("nativescript-local-notifications");
var nativescript_snackbar_1 = require("nativescript-snackbar");
var LineUpComponent = /** @class */ (function (_super) {
    __extends(LineUpComponent, _super);
    function LineUpComponent(changeDetectorRef, userService) {
        var _this = _super.call(this, changeDetectorRef) || this;
        _this.changeDetectorRef = changeDetectorRef;
        _this.userService = userService;
        _this.artists = [];
        _this.myShedule = false;
        _this.artistsRef = firebase.firestore.collection("artists_preview").orderBy("name", "asc");
        _this.artistsBySetTime = firebase.firestore.collection("artists_preview").orderBy("set", "asc");
        // Own Schedule
        _this.localSchedule = [];
        _this.myScheduleArtists = [];
        // Artist by time
        _this.firstDay = [];
        _this.secondDay = [];
        _this.thirdDay = [];
        _this.fourthDay = [];
        // Artist by stages and times
        _this.mainStageSchedule = [];
        _this.plazaSchedule = [];
        _this.esplanadaSchedule = [];
        _this.carpaSchedule = [];
        // Stage toggles
        _this.mainStageToggle = false;
        _this.plazaToggle = false;
        _this.esplanadaToggle = false;
        _this.carpaToggle = false;
        return _this;
    }
    LineUpComponent.prototype.ngOnInit = function () {
        var _this = this;
        LocalNotifications.hasPermission();
        //LocalNotifications.cancelAll();
        this.artistsRef.get().then(function (snap) {
            snap.forEach(function (artist) {
                _this.artists.push(artist.data());
            });
        });
        this.fillSchedule();
        firebase.firestore.collection("user_schedules").doc(this.userService.userId).collection('artists').get().then(function (data) {
            data.forEach(function (element) {
                var date = new Date(element.data().set);
                element.data().set = date;
                _this.localSchedule.push(element.data());
            });
        }).then(function () {
            _this.localSchedule = _this.localSchedule.sort(function (a, b) { return new Date(a.set).getTime() - new Date(b.set).getTime(); });
        });
    };
    LineUpComponent.prototype.addToSchedule = function (artist) {
        // Create an instance of SnackBar
        var snackbar = new nativescript_snackbar_1.SnackBar();
        var found = false;
        if (this.localSchedule.length > 0) {
            this.localSchedule.forEach(function (myArtist) {
                if (myArtist.id === artist.id) {
                    found = true;
                    snackbar.simple(artist.name + " ja existeix al horari!", '#fff', 'red');
                }
            });
        }
        if (!found) {
            snackbar.simple(artist.name + " s'ha afegit al horari!", '#fff', 'green');
            this.setNotification(artist);
            this.localSchedule.push(artist);
            firebase.firestore.collection('user_schedules').doc(this.userService.userId).collection('artists').doc(artist.id).set(artist);
        }
    };
    LineUpComponent.prototype.removeFromSchedule = function (artist) {
        var _this = this;
        this.localSchedule.forEach(function (myArtist, index) {
            if (myArtist.id === artist.id) {
                _this.localSchedule.splice(index, 1);
                firebase.firestore.collection('user_schedules').doc(_this.userService.userId).collection('artists').doc(artist.id).delete();
            }
        });
    };
    LineUpComponent.prototype.fillSchedule = function () {
        var _this = this;
        this.artistsBySetTime
            .get()
            .then(function (snap) {
            snap.forEach(function (doc) {
                if (doc.data().day == 'Dijous 28') {
                    _this.firstDay.push(doc.data());
                }
                else if (doc.data().day == 'Divendres 29') {
                    _this.secondDay.push(doc.data());
                }
                else if (doc.data().day == 'Dissabte 30') {
                    _this.thirdDay.push(doc.data());
                }
                else if (doc.data().day == 'Diumenge 1') {
                    _this.fourthDay.push(doc.data());
                }
                if (doc.data().stage === 'MAIN STAGE') {
                    _this.mainStageSchedule.push(doc.data());
                }
                else if (doc.data().stage === 'CARPA') {
                    _this.carpaSchedule.push(doc.data());
                }
                else if (doc.data().stage === 'PLAÃ‡A') {
                    _this.plazaSchedule.push(doc.data());
                }
                else {
                    _this.esplanadaSchedule.push(doc.data());
                }
            });
        }).then(function () {
            var oldDay = "";
            _this.mainStageSchedule.forEach(function (artist, index) {
                if (oldDay !== artist.day) {
                    _this.mainStageSchedule[index].firstDay = true;
                }
                else {
                    _this.mainStageSchedule[index].firstDay = false;
                }
                oldDay = artist.day;
            });
            var oldDay2 = "";
            _this.carpaSchedule.forEach(function (artist, index) {
                if (oldDay2 !== artist.day) {
                    _this.carpaSchedule[index].firstDay = true;
                }
                else {
                    _this.carpaSchedule[index].firstDay = false;
                }
                oldDay2 = artist.day;
            });
            var oldDay3 = "";
            _this.plazaSchedule.forEach(function (artist, index) {
                if (oldDay3 !== artist.day) {
                    _this.plazaSchedule[index].firstDay = true;
                }
                else {
                    _this.plazaSchedule[index].firstDay = false;
                }
                oldDay3 = artist.day;
            });
            var oldDay4 = "";
            _this.esplanadaSchedule.forEach(function (artist, index) {
                if (oldDay4 !== artist.day) {
                    _this.esplanadaSchedule[index].firstDay = true;
                }
                else {
                    _this.esplanadaSchedule[index].firstDay = false;
                }
                oldDay4 = artist.day;
            });
            var oldDay5 = "";
            _this.firstDay.forEach(function (artist, index) {
                if (oldDay5 !== artist.day) {
                    _this.firstDay[index].firstDay = true;
                }
                else {
                    _this.firstDay[index].firstDay = false;
                }
                oldDay5 = artist.day;
            });
            var oldDay6 = "";
            _this.secondDay.forEach(function (artist, index) {
                if (oldDay6 !== artist.day) {
                    _this.secondDay[index].firstDay = true;
                }
                else {
                    _this.secondDay[index].firstDay = false;
                }
                oldDay6 = artist.day;
            });
            var oldDay7 = "";
            _this.thirdDay.forEach(function (artist, index) {
                if (oldDay7 !== artist.day) {
                    _this.thirdDay[index].firstDay = true;
                }
                else {
                    _this.thirdDay[index].firstDay = false;
                }
                oldDay7 = artist.day;
            });
            var oldDay8 = "";
            _this.fourthDay.forEach(function (artist, index) {
                if (oldDay8 !== artist.day) {
                    _this.fourthDay[index].firstDay = true;
                }
                else {
                    _this.fourthDay[index].firstDay = false;
                }
                oldDay8 = artist.day;
            });
            _this.bySetTime = [].concat(_this.firstDay, _this.secondDay, _this.thirdDay, _this.fourthDay);
        });
    };
    LineUpComponent.prototype.setNotification = function (artist) {
        // Set new notification 15mins before set Time
        var d = new Date(artist.set);
        d.setTime(d.getTime() - (900000));
        LocalNotifications.schedule([{
                id: 1,
                title: artist.name + " comen\u00E7ara a les " + artist.startTime + " al " + artist.stage,
                body: "",
                badge: 1,
                groupSummary: artist.name + " is going live in 15 minutes",
                ongoing: false,
                smallIcon: 'res://tent',
                interval: 'minute',
                sound: "customsound-ios.wav",
                at: d
            }]).then(function () {
            console.log("Notification scheduled");
        }, function (error) {
            console.log("scheduling error: " + error);
        });
    };
    LineUpComponent = __decorate([
        core_1.Component({
            selector: "line-up",
            moduleId: module.id,
            providers: [],
            templateUrl: "./line-up.component.html",
            styleUrls: ["./line-up-common.css"]
        }),
        __metadata("design:paramtypes", [core_1.ChangeDetectorRef,
            user_service_1.UserService])
    ], LineUpComponent);
    return LineUpComponent;
}(drawer_page_1.DrawerPage));
exports.LineUpComponent = LineUpComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluZS11cC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsaW5lLXVwLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlFQUErRDtBQUMvRCxzQ0FBb0U7QUFDcEUsK0RBQTZEO0FBQzdELHVEQUF5RDtBQUV6RCxxRUFBdUU7QUFDdkUsK0RBQWtFO0FBVWxFO0lBQXFDLG1DQUFVO0lBMEI3Qyx5QkFDVSxpQkFBb0MsRUFDcEMsV0FBd0I7UUFGbEMsWUFJRSxrQkFBTSxpQkFBaUIsQ0FBQyxTQUN6QjtRQUpTLHVCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsaUJBQVcsR0FBWCxXQUFXLENBQWE7UUEzQmxDLGFBQU8sR0FBVSxFQUFFLENBQUM7UUFDcEIsZUFBUyxHQUFZLEtBQUssQ0FBQztRQUMzQixnQkFBVSxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBQyxLQUFLLENBQUMsQ0FBQztRQUNwRixzQkFBZ0IsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFMUYsZUFBZTtRQUNmLG1CQUFhLEdBQVUsRUFBRSxDQUFDO1FBRTFCLHVCQUFpQixHQUFVLEVBQUUsQ0FBQztRQUM5QixpQkFBaUI7UUFDakIsY0FBUSxHQUFRLEVBQUUsQ0FBQztRQUNuQixlQUFTLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLGNBQVEsR0FBUSxFQUFFLENBQUM7UUFDbkIsZUFBUyxHQUFRLEVBQUUsQ0FBQztRQUNwQiw2QkFBNkI7UUFDN0IsdUJBQWlCLEdBQVEsRUFBRSxDQUFDO1FBQzVCLG1CQUFhLEdBQVEsRUFBRSxDQUFDO1FBQ3hCLHVCQUFpQixHQUFRLEVBQUUsQ0FBQztRQUM1QixtQkFBYSxHQUFRLEVBQUUsQ0FBQztRQUN4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QUMsUUFBUSxDQUFDLENBQUM7Z0JBQzNCLEVBQUUsRUFBRSxDQUFDO2dCQUNMLEtBQUssRUFBSyxNQUFNLENBQUMsSUFBSSw4QkFBb0IsTUFBTSxDQUFDLFNBQVMsWUFBTyxNQUFNLENBQUMsS0FBTztnQkFDOUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ1IsS0FBSyxFQUFFLENBQUM7Z0JBQ1IsWUFBWSxFQUFLLE1BQU0sQ0FBQyxJQUFJLGlDQUE4QjtnQkFDMUQsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsU0FBUyxFQUFFLFlBQVk7Z0JBQ3ZCLFFBQVEsRUFBRSxRQUFRO2dCQUNsQixLQUFLLEVBQUUscUJBQXFCO2dCQUM1QixFQUFFLEVBQUUsQ0FBQzthQUNOLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDSjtZQUNFLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUN4QyxDQUFDLEVBQ0QsVUFBUyxLQUFLO1lBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsQ0FBQztRQUM1QyxDQUFDLENBQ0osQ0FBQTtJQUNILENBQUM7SUFoTlUsZUFBZTtRQVIzQixnQkFBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLFNBQVM7WUFDbkIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25CLFNBQVMsRUFBRSxFQUFFO1lBQ2IsV0FBVyxFQUFFLDBCQUEwQjtZQUN2QyxTQUFTLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQztTQUNwQyxDQUFDO3lDQTZCNkIsd0JBQWlCO1lBQ3ZCLDBCQUFXO09BNUJ2QixlQUFlLENBaU4zQjtJQUFELHNCQUFDO0NBQUEsQUFqTkQsQ0FBcUMsd0JBQVUsR0FpTjlDO0FBak5ZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVXNlclNlcnZpY2UgfSBmcm9tICcuLy4uLy4uL3NoYXJlZC91c2VyL3VzZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IENvbXBvbmVudCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIE9uSW5pdH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgRHJhd2VyUGFnZSB9IGZyb20gXCIuLi8uLi9zaGFyZWQvZHJhd2VyL2RyYXdlci5wYWdlXCI7XHJcbmltcG9ydCBmaXJlYmFzZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtcGx1Z2luLWZpcmViYXNlXCIpXHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xyXG5pbXBvcnQgKiBhcyBMb2NhbE5vdGlmaWNhdGlvbnMgZnJvbSBcIm5hdGl2ZXNjcmlwdC1sb2NhbC1ub3RpZmljYXRpb25zXCI7XHJcbmltcG9ydCB7IFNuYWNrQmFyLCBTbmFja0Jhck9wdGlvbnMgfSBmcm9tIFwibmF0aXZlc2NyaXB0LXNuYWNrYmFyXCI7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogXCJsaW5lLXVwXCIsXHJcbiAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcclxuICBwcm92aWRlcnM6IFtdLFxyXG4gIHRlbXBsYXRlVXJsOiBcIi4vbGluZS11cC5jb21wb25lbnQuaHRtbFwiLFxyXG4gIHN0eWxlVXJsczogW1wiLi9saW5lLXVwLWNvbW1vbi5jc3NcIl1cclxufSlcclxuXHJcbmV4cG9ydCBjbGFzcyBMaW5lVXBDb21wb25lbnQgZXh0ZW5kcyBEcmF3ZXJQYWdlIGltcGxlbWVudHMgT25Jbml0IHtcclxuICBhcnRpc3RzOiBhbnlbXSA9IFtdO1xyXG4gIG15U2hlZHVsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIGFydGlzdHNSZWYgPSBmaXJlYmFzZS5maXJlc3RvcmUuY29sbGVjdGlvbihcImFydGlzdHNfcHJldmlld1wiKS5vcmRlckJ5KFwibmFtZVwiLFwiYXNjXCIpO1xyXG4gIGFydGlzdHNCeVNldFRpbWUgPSBmaXJlYmFzZS5maXJlc3RvcmUuY29sbGVjdGlvbihcImFydGlzdHNfcHJldmlld1wiKS5vcmRlckJ5KFwic2V0XCIsIFwiYXNjXCIpO1xyXG4gIGJ5U2V0VGltZTogYW55O1xyXG4gIC8vIE93biBTY2hlZHVsZVxyXG4gIGxvY2FsU2NoZWR1bGU6IGFueVtdID0gW107XHJcbiAgbXlTY2hlZHVsZUFydGlzdHMkOiBPYnNlcnZhYmxlPGFueT47XHJcbiAgbXlTY2hlZHVsZUFydGlzdHM6IGFueVtdID0gW107XHJcbiAgLy8gQXJ0aXN0IGJ5IHRpbWVcclxuICBmaXJzdERheTogYW55ID0gW107XHJcbiAgc2Vjb25kRGF5OiBhbnkgPSBbXTtcclxuICB0aGlyZERheTogYW55ID0gW107XHJcbiAgZm91cnRoRGF5OiBhbnkgPSBbXTtcclxuICAvLyBBcnRpc3QgYnkgc3RhZ2VzIGFuZCB0aW1lc1xyXG4gIG1haW5TdGFnZVNjaGVkdWxlOiBhbnkgPSBbXTtcclxuICBwbGF6YVNjaGVkdWxlOiBhbnkgPSBbXTtcclxuICBlc3BsYW5hZGFTY2hlZHVsZTogYW55ID0gW107XHJcbiAgY2FycGFTY2hlZHVsZTogYW55ID0gW107XHJcbiAgLy8gU3RhZ2UgdG9nZ2xlc1xyXG4gIG1haW5TdGFnZVRvZ2dsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIHBsYXphVG9nZ2xlOiBib29sZWFuID0gZmFsc2U7XHJcbiAgZXNwbGFuYWRhVG9nZ2xlOiBib29sZWFuID0gZmFsc2U7XHJcbiAgY2FycGFUb2dnbGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yUmVmOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIHByaXZhdGUgdXNlclNlcnZpY2U6IFVzZXJTZXJ2aWNlXHJcbiAgKXtcclxuICAgIHN1cGVyKGNoYW5nZURldGVjdG9yUmVmKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgTG9jYWxOb3RpZmljYXRpb25zLmhhc1Blcm1pc3Npb24oKTtcclxuICAgIC8vTG9jYWxOb3RpZmljYXRpb25zLmNhbmNlbEFsbCgpO1xyXG4gICAgdGhpcy5hcnRpc3RzUmVmLmdldCgpLnRoZW4oc25hcCA9PiB7XHJcbiAgICAgIHNuYXAuZm9yRWFjaChhcnRpc3QgPT4ge1xyXG4gICAgICAgIHRoaXMuYXJ0aXN0cy5wdXNoKGFydGlzdC5kYXRhKCkpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5maWxsU2NoZWR1bGUoKTtcclxuICAgIGZpcmViYXNlLmZpcmVzdG9yZS5jb2xsZWN0aW9uKFwidXNlcl9zY2hlZHVsZXNcIikuZG9jKHRoaXMudXNlclNlcnZpY2UudXNlcklkKS5jb2xsZWN0aW9uKCdhcnRpc3RzJykuZ2V0KCkudGhlbihkYXRhID0+IHtcclxuICAgICAgZGF0YS5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShlbGVtZW50LmRhdGEoKS5zZXQpO1xyXG4gICAgICAgIGVsZW1lbnQuZGF0YSgpLnNldCA9IGRhdGU7IFxyXG4gICAgICAgIHRoaXMubG9jYWxTY2hlZHVsZS5wdXNoKGVsZW1lbnQuZGF0YSgpKTtcclxuICAgICAgfSk7ICBcclxuICAgIH0pLnRoZW4oKCk9PntcclxuICAgICAgdGhpcy5sb2NhbFNjaGVkdWxlID0gdGhpcy5sb2NhbFNjaGVkdWxlLnNvcnQoKGE6IGFueSwgYjogYW55KSA9PiBuZXcgRGF0ZShhLnNldCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYi5zZXQpLmdldFRpbWUoKSk7XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFkZFRvU2NoZWR1bGUoYXJ0aXN0OiBhbnkpOiB2b2lkIHtcclxuICAgIC8vIENyZWF0ZSBhbiBpbnN0YW5jZSBvZiBTbmFja0JhclxyXG4gICAgbGV0IHNuYWNrYmFyID0gbmV3IFNuYWNrQmFyKCk7XHJcbiAgICBsZXQgZm91bmQgPSBmYWxzZTtcclxuICAgIGlmICh0aGlzLmxvY2FsU2NoZWR1bGUubGVuZ3RoPjApIHtcclxuICAgICAgdGhpcy5sb2NhbFNjaGVkdWxlLmZvckVhY2gobXlBcnRpc3QgPT4ge1xyXG4gICAgICAgIGlmIChteUFydGlzdC5pZCA9PT0gYXJ0aXN0LmlkKSB7XHJcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XHJcbiAgICAgICAgICBzbmFja2Jhci5zaW1wbGUoYCR7YXJ0aXN0Lm5hbWV9IGphIGV4aXN0ZWl4IGFsIGhvcmFyaSFgLCAnI2ZmZicsICdyZWQnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgIFxyXG4gICAgfVxyXG4gICAgaWYgKCFmb3VuZCkge1xyXG4gICAgICBzbmFja2Jhci5zaW1wbGUoYCR7YXJ0aXN0Lm5hbWV9IHMnaGEgYWZlZ2l0IGFsIGhvcmFyaSFgLCAnI2ZmZicsICdncmVlbicpO1xyXG4gICAgICB0aGlzLnNldE5vdGlmaWNhdGlvbihhcnRpc3QpO1xyXG4gICAgICB0aGlzLmxvY2FsU2NoZWR1bGUucHVzaChhcnRpc3QpO1xyXG4gICAgICBmaXJlYmFzZS5maXJlc3RvcmUuY29sbGVjdGlvbigndXNlcl9zY2hlZHVsZXMnKS5kb2ModGhpcy51c2VyU2VydmljZS51c2VySWQpLmNvbGxlY3Rpb24oJ2FydGlzdHMnKS5kb2MoYXJ0aXN0LmlkKS5zZXQoYXJ0aXN0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyByZW1vdmVGcm9tU2NoZWR1bGUoYXJ0aXN0OiBhbnkpOiB2b2lkIHtcclxuICAgIHRoaXMubG9jYWxTY2hlZHVsZS5mb3JFYWNoKChteUFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICBpZiAobXlBcnRpc3QuaWQgPT09IGFydGlzdC5pZCkge1xyXG4gICAgICAgIHRoaXMubG9jYWxTY2hlZHVsZS5zcGxpY2UoaW5kZXgsMSk7XHJcbiAgICAgICAgZmlyZWJhc2UuZmlyZXN0b3JlLmNvbGxlY3Rpb24oJ3VzZXJfc2NoZWR1bGVzJykuZG9jKHRoaXMudXNlclNlcnZpY2UudXNlcklkKS5jb2xsZWN0aW9uKCdhcnRpc3RzJykuZG9jKGFydGlzdC5pZCkuZGVsZXRlKCk7XHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZpbGxTY2hlZHVsZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuYXJ0aXN0c0J5U2V0VGltZVxyXG4gICAgLmdldCgpXHJcbiAgICAudGhlbihzbmFwID0+IHtcclxuICAgICAgc25hcC5mb3JFYWNoKGRvYyA9PiB7XHJcbiAgICAgICAgaWYoZG9jLmRhdGEoKS5kYXkgPT0gJ0Rpam91cyAyOCcpIHtcclxuICAgICAgICAgIHRoaXMuZmlyc3REYXkucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGRvYy5kYXRhKCkuZGF5ID09ICdEaXZlbmRyZXMgMjknKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2Vjb25kRGF5LnB1c2goZG9jLmRhdGEoKSk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGRvYy5kYXRhKCkuZGF5ID09ICdEaXNzYWJ0ZSAzMCcpIHtcclxuICAgICAgICAgICAgICB0aGlzLnRoaXJkRGF5LnB1c2goZG9jLmRhdGEoKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jLmRhdGEoKS5kYXkgPT0gJ0RpdW1lbmdlIDEnKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuZm91cnRoRGF5LnB1c2goZG9jLmRhdGEoKSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgIGlmKGRvYy5kYXRhKCkuc3RhZ2UgPT09ICdNQUlOIFNUQUdFJykge1xyXG4gICAgICAgICAgdGhpcy5tYWluU3RhZ2VTY2hlZHVsZS5wdXNoKGRvYy5kYXRhKCkpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZG9jLmRhdGEoKS5zdGFnZSA9PT0gJ0NBUlBBJykge1xyXG4gICAgICAgICAgICB0aGlzLmNhcnBhU2NoZWR1bGUucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoZG9jLmRhdGEoKS5zdGFnZSA9PT0gJ1BMQcOHQScpIHtcclxuICAgICAgICAgICAgICB0aGlzLnBsYXphU2NoZWR1bGUucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXNwbGFuYWRhU2NoZWR1bGUucHVzaChkb2MuZGF0YSgpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pLnRoZW4oKCk9PntcclxuICAgICAgbGV0IG9sZERheSA9IFwiXCI7XHJcbiAgICAgIHRoaXMubWFpblN0YWdlU2NoZWR1bGUuZm9yRWFjaCgoYXJ0aXN0LGluZGV4KSA9PiB7XHJcbiAgICAgICAgaWYob2xkRGF5ICE9PSBhcnRpc3QuZGF5KXtcclxuICAgICAgICAgIHRoaXMubWFpblN0YWdlU2NoZWR1bGVbaW5kZXhdLmZpcnN0RGF5ID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5tYWluU3RhZ2VTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5ID0gYXJ0aXN0LmRheTtcclxuICAgICAgfSk7XHJcbiAgICAgIGxldCBvbGREYXkyID0gXCJcIjtcclxuICAgICAgdGhpcy5jYXJwYVNjaGVkdWxlLmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTIgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy5jYXJwYVNjaGVkdWxlW2luZGV4XS5maXJzdERheSA9IHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuY2FycGFTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5MiA9IGFydGlzdC5kYXk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBsZXQgb2xkRGF5MyA9IFwiXCI7XHJcbiAgICAgIHRoaXMucGxhemFTY2hlZHVsZS5mb3JFYWNoKChhcnRpc3QsaW5kZXgpID0+IHtcclxuICAgICAgICBpZihvbGREYXkzICE9PSBhcnRpc3QuZGF5KXtcclxuICAgICAgICAgIHRoaXMucGxhemFTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLnBsYXphU2NoZWR1bGVbaW5kZXhdLmZpcnN0RGF5ID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9sZERheTMgPSBhcnRpc3QuZGF5O1xyXG4gICAgICB9KTtcclxuICAgICAgbGV0IG9sZERheTQgPSBcIlwiO1xyXG4gICAgICB0aGlzLmVzcGxhbmFkYVNjaGVkdWxlLmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTQgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy5lc3BsYW5hZGFTY2hlZHVsZVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmVzcGxhbmFkYVNjaGVkdWxlW2luZGV4XS5maXJzdERheSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvbGREYXk0ID0gYXJ0aXN0LmRheTtcclxuICAgICAgfSk7XHJcbiAgICAgIGxldCBvbGREYXk1ID0gXCJcIjtcclxuICAgICAgdGhpcy5maXJzdERheS5mb3JFYWNoKChhcnRpc3QsaW5kZXgpID0+IHtcclxuICAgICAgICBpZihvbGREYXk1ICE9PSBhcnRpc3QuZGF5KXtcclxuICAgICAgICAgIHRoaXMuZmlyc3REYXlbaW5kZXhdLmZpcnN0RGF5ID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5maXJzdERheVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5NSA9IGFydGlzdC5kYXk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBsZXQgb2xkRGF5NiA9IFwiXCI7XHJcbiAgICAgIHRoaXMuc2Vjb25kRGF5LmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTYgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy5zZWNvbmREYXlbaW5kZXhdLmZpcnN0RGF5ID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5zZWNvbmREYXlbaW5kZXhdLmZpcnN0RGF5ID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9sZERheTYgPSBhcnRpc3QuZGF5O1xyXG4gICAgICB9KTtcclxuICAgICAgbGV0IG9sZERheTcgPSBcIlwiO1xyXG4gICAgICB0aGlzLnRoaXJkRGF5LmZvckVhY2goKGFydGlzdCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmKG9sZERheTcgIT09IGFydGlzdC5kYXkpe1xyXG4gICAgICAgICAgdGhpcy50aGlyZERheVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLnRoaXJkRGF5W2luZGV4XS5maXJzdERheSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvbGREYXk3ID0gYXJ0aXN0LmRheTtcclxuICAgICAgfSk7XHJcbiAgICAgIGxldCBvbGREYXk4ID0gXCJcIjtcclxuICAgICAgdGhpcy5mb3VydGhEYXkuZm9yRWFjaCgoYXJ0aXN0LGluZGV4KSA9PiB7XHJcbiAgICAgICAgaWYob2xkRGF5OCAhPT0gYXJ0aXN0LmRheSl7XHJcbiAgICAgICAgICB0aGlzLmZvdXJ0aERheVtpbmRleF0uZmlyc3REYXkgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmZvdXJ0aERheVtpbmRleF0uZmlyc3REYXkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb2xkRGF5OCA9IGFydGlzdC5kYXk7XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLmJ5U2V0VGltZSA9IFtdLmNvbmNhdCh0aGlzLmZpcnN0RGF5LHRoaXMuc2Vjb25kRGF5LHRoaXMudGhpcmREYXksdGhpcy5mb3VydGhEYXkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0Tm90aWZpY2F0aW9uKGFydGlzdDogYW55KTogdm9pZCB7XHJcbiAgICAvLyBTZXQgbmV3IG5vdGlmaWNhdGlvbiAxNW1pbnMgYmVmb3JlIHNldCBUaW1lXHJcbiAgICBjb25zdCBkID0gbmV3IERhdGUoYXJ0aXN0LnNldCk7XHJcbiAgICBkLnNldFRpbWUoZC5nZXRUaW1lKCktKDkwMDAwMCkpO1xyXG5cclxuICAgIExvY2FsTm90aWZpY2F0aW9ucy5zY2hlZHVsZShbe1xyXG4gICAgICBpZDogMSxcclxuICAgICAgdGl0bGU6IGAke2FydGlzdC5uYW1lfSBjb21lbsOnYXJhIGEgbGVzICR7YXJ0aXN0LnN0YXJ0VGltZX0gYWwgJHthcnRpc3Quc3RhZ2V9YCxcclxuICAgICAgYm9keTogXCJcIixcclxuICAgICAgYmFkZ2U6IDEsXHJcbiAgICAgIGdyb3VwU3VtbWFyeTogYCR7YXJ0aXN0Lm5hbWV9IGlzIGdvaW5nIGxpdmUgaW4gMTUgbWludXRlc2AsIC8vYW5kcm9pZCBvbmx5XHJcbiAgICAgIG9uZ29pbmc6IGZhbHNlLCAvLyBtYWtlcyB0aGUgbm90aWZpY2F0aW9uIG9uZ29pbmcgKEFuZHJvaWQgb25seSlcclxuICAgICAgc21hbGxJY29uOiAncmVzOi8vdGVudCcsXHJcbiAgICAgIGludGVydmFsOiAnbWludXRlJyxcclxuICAgICAgc291bmQ6IFwiY3VzdG9tc291bmQtaW9zLndhdlwiLCAvLyBmYWxscyBiYWNrIHRvIHRoZSBkZWZhdWx0IHNvdW5kIG9uIEFuZHJvaWRcclxuICAgICAgYXQ6IGRcclxuICAgIH1dKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJOb3RpZmljYXRpb24gc2NoZWR1bGVkXCIpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKFwic2NoZWR1bGluZyBlcnJvcjogXCIgKyBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgKVxyXG4gIH1cclxufSJdfQ==